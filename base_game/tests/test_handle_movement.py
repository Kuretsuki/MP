import pytest
from game_main_controls import handle_movement

@pytest.mark.parametrize(
    "grid, x, y, i, j, prev_loc, current_mush, mushrooms, expected_current_loc, expected_prev, expected__current_mush",
    [
    # Tests for simply checking functionality 

        # Move right
        ([["L", ".", "."]], 0, 0, 0, 1, ".", 0, 0, (0, 1), ".", 0),

        # Move left
        ([[".", "L", "."]], 0, 1, 0, -1, ".", 0, 0, (0, 0), ".", 0),

        # Move down 
        ([["L"], ["."]], 0, 0, 1, 0, ".", 0, 0, (1, 0), ".", 0),

        # Move up 
        ([[".",], ["L"]], 1, 0, -1, 0, ".", 0, 0, (0, 0), ".", 0),


    # Tests for more exact conditions

        # Going into a tree
        ([['.', '.', "T"], ['.', '.', "T"], ["T", "T", "T"]], 0, 1, 0, 1, ".", 0, 0, (0, 1), ".", 0),

        # Going from a paved tile into a tile with mushroom
        ([['.', '.', "T"], ['_', '.', "T"], ["+", ".", "T"]], 1, 0, 1, 0, "_", 0, 1, (2, 0), ".", 1),

        # Trying to go beyond the grid
        ([['.', '.', "T"], ['.', '.', "T"], ["+", "_", "_"]], 0, 0, -1, 0, ".", 0, 1, (0, 0), ".", 0),

        # Moving towards a rock that can be pushed
        # Water in front of rock
        ([
            ["T","T","T","T","T","T","T","T","T"],
            ["T",".",".",".","+",".",".","+","T"],
            ["T","+",".",".","~",".",".",".","T"],
            ["T",".",".",".","R",".","T",".","T"],
            ["T",".","T",".",".","T","T",".","T"],
            ["T",".","x",".",".",".","*",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T","T","T","T","T","T","T","T","T"]
        ], 4, 4, -1, 0, ".", 0, 3, (3, 4), ".", 0),

        # Moving towards a rock that can be pushed
        # Paved tile in front of rock
        ([
            ["T","T","T","T","T","T","T","T","T"],
            ["T",".",".",".","+",".",".","+","T"],
            ["T","+",".",".","_",".",".",".","T"],
            ["T",".",".",".","R",".","T",".","T"],
            ["T",".","T",".",".","T","T",".","T"],
            ["T",".","x",".",".",".","*",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T","T","T","T","T","T","T","T","T"]
        ], 4, 4, -1, 0, ".", 0, 3, (3, 4), ".", 0),


        # Moving towards a rock that can be pushed
        # Empty tile in front of rock
        ([
            ["T","T","T","T","T","T","T","T","T"],
            ["T",".",".",".","+",".",".","+","T"],
            ["T","+",".",".",".",".",".",".","T"],
            ["T",".",".",".","R",".","T",".","T"],
            ["T",".","T",".",".","T","T",".","T"],
            ["T",".","x",".",".",".","*",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T","T","T","T","T","T","T","T","T"]
        ], 4, 4, -1, 0, ".", 0, 3, (3, 4), ".", 0),


        # Moving towards a rock that can be pushed
        # Blocked by a rock
        ([
            ["T","T","T","T","T","T","T","T","T"],
            ["T",".",".",".","+",".",".","+","T"],
            ["T","+",".",".","R",".",".",".","T"],
            ["T",".",".",".","R",".","T",".","T"],
            ["T",".","T",".",".","T","T",".","T"],
            ["T",".","x",".",".",".","*",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T","T","T","T","T","T","T","T","T"]
        ], 4, 4, -1, 0, ".", 0, 3, (4, 4), ".", 0),

        # Moving towards a rock that can be pushed
        # Blocked by a tree
        ([
            ["T","T","T","T","T","T","T","T","T"],
            ["T",".",".",".","+",".",".","+","T"],
            ["T","+",".",".","T",".",".",".","T"],
            ["T",".",".",".","R",".","T",".","T"],
            ["T",".","T",".",".","T","T",".","T"],
            ["T",".","x",".",".",".","*",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T","T","T","T","T","T","T","T","T"]
        ], 4, 4, -1, 0, ".", 0, 3, (4, 4), ".", 0),

        # Moving towards a rock that can be pushed
        # Blocked by a mushroom
        ([
            ["T","T","T","T","T","T","T","T","T"],
            ["T",".",".",".","+",".",".","+","T"],
            ["T","+",".",".","+",".",".",".","T"],
            ["T",".",".",".","R",".","T",".","T"],
            ["T",".","T",".",".","T","T",".","T"],
            ["T",".","x",".",".",".","*",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T","T","T","T","T","T","T","T","T"]
        ], 4, 4, -1, 0, ".", 0, 3, (4, 4), ".", 0),

        # Moving towards water
        ([
            ["T","T","T","T","T","T","T","T","T"],
            ["T",".",".",".","+",".",".","+","T"],
            ["T","+",".",".","~",".",".",".","T"],
            ["T",".",".",".","R",".","T",".","T"],
            ["T",".","T",".",".","T","T",".","T"],
            ["T",".","x",".",".",".","*",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T","T","T","T","T","T","T","T","T"]
        ], 2, 3, 0, 1, ".", 0, 3, (2, 4), ".", 0),

        # Moving into a mushroom (collects mushroom)
        ([
            ["T","T","T","T","T","T","T","T","T"],
            ["T",".",".","+",".",".",".",".","T"],
            ["T",".","R",".","~",".",".",".","T"],
            ["T",".",".",".",".",".","*",".","T"],
            ["T",".","x",".",".",".",".",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T","T","T","T","T","T","T","T","T"]
        ], 1, 2, 0, 1, ".", 0, 1, (1, 3), ".", 1),  


        # Moving towards a flamethrower
        ([
            ["T","T","T","T","T","T","T","T","T"],
            ["T",".",".","+",".",".",".",".","T"],
            ["T",".","R",".","~",".",".",".","T"],
            ["T",".",".",".",".",".","*",".","T"],
            ["T",".","x",".",".",".",".",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T","T","T","T","T","T","T","T","T"]
        ], 3, 5, 0, 1, '.', 0, 1, (3, 6), '*', 0),  

        # Moving towards an axe
        ([
            ["T","T","T","T","T","T","T","T","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T",".",".",".",".","x",".",".","T"],  
            ["T",".",".",".",".",".",".",".","T"],
            ["T",".",".",".",".",".",".",".","T"],  
            ["T",".",".",".",".",".",".",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T",".",".",".",".",".",".",".","T"],
            ["T","T","T","T","T","T","T","T","T"]
        ], 2, 4, 0, 1, ".", 0, 0, (2, 5), "x", 0),
    ]
)
def test_movement_only(mocker, grid, x, y, i, j, prev_loc, current_mush, mushrooms,
                       expected_current_loc, expected_prev, expected__current_mush):
    mocker.patch("game_main_controls.clear")
    mocker.patch("game_main_controls.load_mapp")
    mocker.patch("time.sleep", return_value=None)

    current_loc, previous_loc, held_items_out, current_mush, _, _, _ = handle_movement(
        grid, x, y, i, j, None, prev_loc, current_mush, mushrooms, {}
    )

    assert current_loc == expected_current_loc
    assert previous_loc == expected_prev
    assert current_mush == expected__current_mush
